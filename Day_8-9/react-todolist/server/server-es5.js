module.exports=function(e){function t(o){if(s[o])return s[o].exports;var n=s[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var s={};return t.m=e,t.c=s,t.d=function(e,s,o){t.o(e,s)||Object.defineProperty(e,s,{configurable:!1,enumerable:!0,get:o})},t.n=function(e){var s=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(s,"a",s),s},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=7)}([function(e,t){e.exports=require("passport-jwt")},function(e,t,s){"use strict";var o={siteTitle:"OAuth App",dbLocation:"mongodb://localhost/oauth-app",facebookConfig:{appID:"1898036960240703",appSecret:"346b72bd7f340223fe6d0818ca1c5d8d",callbackUrl:"http://localhost:3000/auth/login/facebook/callback"},googleConfig:{appID:"430175608680-k5rm1a736a4lmgp04ti8hukff7pjpa89.apps.googleusercontent.com",appSecret:"2qSI3qNebIGxGtK0XUeYbA5l",callbackUrl:"http://localhost:3000/auth/login/google/callback"},jwtSecret:"myLittlePony"};e.exports=o},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("passport")},function(e,t){e.exports=require("passport-local")},function(e,t){e.exports=require("superagent")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,s){"use strict";var o=s(1),n=s(8),r=s(9),a=s(2),i=s(10),u=(s(11),s(12)),l=s(3),c=s(13),g=s(14);u.connect(o.dbLocation);var d=(u.connection,s(15)),f=s(17),m=new a;m.set("view engine","ejs"),m.set("views",c.join(__dirname,"views")),m.use(n.json()),m.use(n.urlencoded({extended:!0})),m.use(r()),m.use(a.static(c.join(__dirname,"static"))),m.use(g({secret:"supersecret",saveUninitialized:!0,resave:!0})),m.use(i({errorFormatter:function(e,t,s){for(var o=e.split("."),n=o.shift(),r=n;o.length;)r+="["+o.shift()+"]";return{param:r,msg:t,value:s}}})),m.use(l.initialize()),m.use(l.session()),m.get("*",function(e,t){return t.status(200).render("index",{markup:""})}),m.post("/testpost",function(e,t){t.status(200).json({message:"test response."})}),m.use("/auth",d),m.use("/api",f);var p=process.env.PORT||3e3;m.listen(p,function(e){return e?console.error(e):console.info("\n      Server running on http://localhost:"+p+" [production]\n      Universal rendering: "+(process.env.UNIVERSAL?"enabled":"disabled")+"\n    ")})},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("express-validator")},function(e,t){e.exports=require("mongodb")},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("express-session")},function(e,t,s){"use strict";var o=s(1),n=s(!function(){var e=new Error('Cannot find module "../models/User"');throw e.code="MODULE_NOT_FOUND",e}()),r=s(5),a=s(6),i=s(3),u=s(0).Strategy,l=s(0).ExtractJwt,c=s(4).Strategy,g=(s(4).Strategy,s(4).Strategy,s(16)),d=(g.plus("v1"),g.auth.OAuth2),f=new d(o.googleConfig.appID,o.googleConfig.appSecret,o.googleConfig.callbackUrl);i.serializeUser(function(e,t){t(null,e.id)}),i.deserializeUser(function(e,t){n.getUserById(e,function(e,s){t(e,s)})}),i.use("jwt",new u({jwtFromRequest:l.fromBodyField("Authorization"),secretOrKey:o.jwtSecret},function(e,t){n.getUserById(e.id,function(e,s){return console.log("USER = "+JSON.stringify(s)),e?(console.log("Throwing error: "+e),t(e,!1)):s?t(null,s):t("You are not authorized",!1)})})),i.use("local",new c(function(e,t,s){n.getUserByLocalUsername(e,function(e,o){if(e)throw console.log("Throwing error"),e;if(!o)return s(null,!1,{message:"Unknown User"});n.comparePassword(t,o.local.password,function(e,t){if(e)throw console.log("Throwing error"),e;return t?s(null,o):s(null,!1,{message:"Invalid password"})})})}));var m=function(e,t){r.get("https://graph.facebook.com/me").query({access_token:e,fields:"name,email"}).set("Accept","application/json").end(function(s,o){!s&&o.ok||t(s);var r=o.body;n.getUserByFacebookId(r.id,function(s,o){if(s)throw console.log("Throwing error"),s;if(o)return t(null,o);var a=new n;a.email=r.email,a.name=r.name,a.reg_source="facebook",a.facebook.id=r.id,a.facebook.token=e,n.createFacebookUser(a,function(e,s){return e?t(e):t(null,a)})})})},f=function(e,t){r.get("https://www.googleapis.com/plus/v1/people/me").query({access_token:e}).set("Accept","application/json").end(function(s,o){!s&&o.ok||t(s),n.getUserByGoogleId(o.id,function(s,r){if(s)throw console.log("Throwing error"),s;if(r)return t(null,r);var a=new n;a.email=o.emails[0].value,a.name=o.displayName,a.reg_source="google",a.google.id=o.id,a.google.token=e,n.createGoogleUser(a,function(e,s){return e?t(e):t(null,a)})})})},p=s(2),h=p.Router();h.post("/login/local",function(e,t){i.authenticate("local",function(s,n,r){return s?(console.log(s),t.status(403).json({message:s})):n?void e.logIn(n,function(e){if(e)return console.log(e),t.status(403).json({message:e});var s={id:n._id},r=a.sign(s,o.jwtSecret);return t.status(200).json({message:"User has been authorized",token:r})}):t.status(401).json(r)})(e,t)}),h.post("/login/facebook",function(e,t){m(e.body.socialtoken,function(e,s,n){if(e)return console.log(e),t.status(403).json({message:e});if(!s)return t.status(401).json(n);var r={id:s._id},i=a.sign(r,o.jwtSecret);return t.status(200).json({message:"User has been authorized",token:i})})}),h.post("/login/google",function(e,t){f(e.body.socialtoken,function(e,s,n){if(e)return console.log(e),t.status(403).json({message:e});if(!s)return t.status(401).json(n);var r={id:s._id},i=a.sign(r,o.jwtSecret);return t.status(200).json({message:"User has been authorized",token:i})})}),h.post("/register/local",function(e,t){var s=e.body.firstname,o=e.body.lastname,r=e.body.email,a=e.body.username,i=e.body.password1;e.body.password2;e.checkBody("firstname","First name is required").notEmpty(),e.checkBody("lastname","Last name is required").notEmpty(),e.checkBody("email","Email name is required").notEmpty(),e.checkBody("username","Username is required").notEmpty(),e.checkBody("password1","Password is required").notEmpty(),e.checkBody("password2","Re-enter your password").notEmpty(),e.checkBody("email","Not a valid email").isEmail(),e.checkBody("password2","Passwords do not match").equals(i);var u=e.validationErrors();if(u)return t.status(403).json({message:"There was an error in the registration form",errors:u});var l=new n;l.name=s+" "+o,l.email=r,l.reg_source="local",l.local.username=a,l.local.password=i;try{n.createLocalUser(l,function(e,t){if(e)throw e;console.log("User has been created: "),console.log(t)})}catch(e){console.log(e),t.status(409).json({message:"User registration could not be fulfilled at this time"})}return t.status(200).json({message:"User registered succesfully."})}),e.exports=h},function(e,t){e.exports=require("googleapis")},function(e,t,s){"use strict";var o=(s(1),s(!function(){var e=new Error('Cannot find module "../models/User"');throw e.code="MODULE_NOT_FOUND",e}()),s(!function(){var e=new Error('Cannot find module "../models/Task"');throw e.code="MODULE_NOT_FOUND",e}())),n=s(!function(){var e=new Error('Cannot find module "../models/Tasktag"');throw e.code="MODULE_NOT_FOUND",e}()),r=(s(5),s(6),s(3)),a=(s(0).Strategy,s(0).ExtractJwt,s(2)),i=a.Router();i.post("/task_create",r.authenticate("jwt",{session:!1}),function(e,t){var s={};if(e.checkBody("title","Task title is required").notEmpty(),e.checkBody("tags","List of task tags is required in request").exists(),e.validationErrors()&&(s=e.validationErrors()),e.body.tags)for(var r=0;r<e.body.tags.length;r++)n.tagExists(e.body.tags[r])||(s.tags="Tag with id "+e.body.tags[r]+" does not exist in DB");if(0!==Object.keys(s).length)return t.status(400).json({message:"Unable to create task with this title and tags",errors:s});var a=e.body.title,i=e.body.tags,u=new o;u.user_id=e.user._id,u.date_created=new Date,u.title=a,u.marked_done=!1,u.tags=i,o.createTask(u,function(e,s){return e?(console.log("err = "+e),t.status(400).json({message:"Unable to insert task in DB",error:e.message})):s?t.status(200).json({message:"Task created succesfully",task:s}):t.status(400).json({message:"Unable to insert task in DB"})})}),i.post("/task_toggledone",r.authenticate("jwt",{session:!1}),function(e,t){if(e.checkBody("id","Id must be a 24 byte hex string ID").isMongoId(),e.validationErrors())return t.status(400).json({message:"Unable to create task with this title and tags",errors:e.validationErrors()});e.body.id;o.toggleDone(e.body.id,function(e,s){return e?(console.log("Error on task toggle = "+e),t.status(400).json({message:"Unable to toggle task in database",error:e.message})):s?t.status(200).json({message:"Task toggled succesfully"}):t.status(400).json({message:"Unable to toggle task in database"})})}),i.post("/task_delete",r.authenticate("jwt",{session:!1}),function(e,t){if(e.checkBody("id","Id must be a 24 byte hex string ID").isMongoId(),e.validationErrors())return t.status(400).json({message:"Unable to delete task with this ID",errors:e.validationErrors()});o.deleteTask(e.body.id,function(e,s){return e?(console.log("Error on task delete = "+e),t.status(400).json({message:"Unable to delete task in database",error:e.message})):s?t.status(200).json({message:"Task deleted succesfully"}):t.status(400).json({message:"Unable to delete task in database"})})}),i.post("/task_getall",r.authenticate("jwt",{session:!1}),function(e,t){o.getUserTasks(e.user._id,function(e,s){return e?(console.log("Error on task getall = "+e),t.status(400).json({message:"Unable to get tasks",error:e.message})):s?t.status(200).json({message:"Tasks retrieved succesfully",tasks:s}):t.status(400).json({message:"Unable to get tasks"})})}),i.post("/tasktag_getall",r.authenticate("jwt",{session:!1}),function(e,t){n.getUserTags(e.user._id,function(e,s){return e?(console.log("Error on task getall = "+e),t.status(400).json({message:"Unable to get tags",error:e.message})):s?t.status(200).json({message:"Tags retrieved succesfully",tags:s}):t.status(400).json({message:"Unable to get tags"})})}),i.post("/tasktag_create",r.authenticate("jwt",{session:!1}),function(e,t){if(e.checkBody("name","Tag name is required").notEmpty(),e.validationErrors())return t.status(400).json({message:"Unable to insert tag in DB",errors:e.validationErrors()});var s=new n;s.user_id=e.user._id,s.name=e.body.name,n.createTag(s,function(e,s){return e?(console.log("err = "+e),t.status(400).json({message:"Unable to insert tag in DB",error:e.message})):s?t.status(200).json({message:"Tag created succesfully",tag:s}):t.status(400).json({message:"Unable to insert tag in DB"})})}),i.post("/tasktag_delete",r.authenticate("jwt",{session:!1}),function(e,t){if(e.checkBody("id","Tag ID was not provided").isEmpty(),e.validationErrors())return t.status(400).json({message:"Unable to delete tag with this name",errors:e.validationErrors()});n.deleteTask(e.body.id,function(e,s){return e?(console.log("Error on tag delete = "+e),t.status(400).json({message:"Unable to delete tag in database",error:e.message})):s?t.status(200).json({message:"Tag deleted succesfully"}):t.status(400).json({message:"Unable to delete tag in database"})})}),i.post("/example",r.authenticate("jwt",{session:!1}),function(e,t){console.log("Example of a protected api called"),t.status(200).json({message:"You are authorized as "+e.user.name})}),e.exports=i}]);